<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="theme-color" content="#000000">
	<link rel="manifest" href="/manifest.json">
	<link rel="icon" type="image/png" href="/image.png">
	<link rel="apple-touch-icon" href="/image.png">
	<link rel="stylesheet" href="styles.css">
	<title>Cocina - Sistema Restaurante</title>
	<style>
		body {
			background: #000000;
			padding: 0;
			margin: 0;
		}

		.kitchen-header {
			background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
			padding: 20px 30px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
			position: sticky;
			top: 0;
			z-index: 100;
		}

		.kitchen-header h1 {
			margin: 0;
			color: #fff;
			font-size: 28px;
			display: flex;
			align-items: center;
			gap: 15px;
		}

		.kitchen-controls {
			display: flex;
			gap: 15px;
		}

		.kitchen-main {
			padding: 30px;
			max-width: 1800px;
			margin: 0 auto;
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}

		.stat-box {
			background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
			padding: 25px;
			border-radius: 12px;
			border: 2px solid rgba(255, 107, 53, 0.2);
			text-align: center;
		}

		.stat-box h3 {
			color: var(--muted);
			font-size: 14px;
			margin: 0 0 10px 0;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		.stat-box .value {
			color: var(--accent);
			font-size: 48px;
			font-weight: 700;
			margin: 0;
		}

		.orders-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
			gap: 25px;
		}

		.order-card {
			background: #1a1a1a;
			border-radius: 12px;
			padding: 20px;
			border-left: 5px solid #ff9800;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
			transition: transform 0.2s, box-shadow 0.2s;
		}

		.order-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
		}

		.order-card.urgent {
			border-left-color: #ff4444;
			animation: pulse 2s infinite;
		}

		.order-card.ready {
			border-left-color: #4caf50;
		}

		@keyframes pulse {
			0%, 100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }
			50% { box-shadow: 0 4px 25px rgba(255, 68, 68, 0.6); }
		}

		.order-header {
			display: flex;
			justify-content: space-between;
			align-items: start;
			margin-bottom: 15px;
			padding-bottom: 15px;
			border-bottom: 2px solid rgba(255, 107, 53, 0.2);
		}

		.order-header h2 {
			color: var(--accent);
			font-size: 32px;
			margin: 0;
		}

		.order-time {
			color: var(--muted);
			font-size: 14px;
			margin-top: 5px;
		}

		.items-list {
			background: #0a0a0a;
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 15px;
		}

		.item-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px 0;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}

		.item-row:last-child {
			border-bottom: none;
		}

		.item-info {
			flex: 1;
		}

		.item-name {
			font-weight: 600;
			color: var(--accent);
			font-size: 16px;
			margin-bottom: 4px;
		}

		.item-notes {
			color: #ff9800;
			font-size: 12px;
			font-style: italic;
		}

		.item-actions {
			display: flex;
			gap: 10px;
			align-items: center;
		}

		.status-badge {
			padding: 6px 12px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 600;
			min-width: 110px;
			text-align: center;
		}

		.status-pending { background: #666; color: #fff; }
		.status-preparing { background: #ff9800; color: #fff; }
		.status-ready { background: #4caf50; color: #fff; }

		.btn-action {
			padding: 8px 16px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-weight: 600;
			font-size: 12px;
			transition: transform 0.2s;
		}

		.btn-action:hover {
			transform: scale(1.05);
		}

		.btn-action:active {
			transform: scale(0.95);
		}

		.btn-start {
			background: #ff9800;
			color: #fff;
		}

		.btn-ready {
			background: #4caf50;
			color: #fff;
		}

		.btn-notify {
			width: 100%;
			padding: 15px;
			background: #4caf50;
			color: #fff;
			border: none;
			border-radius: 8px;
			font-size: 16px;
			font-weight: 700;
			cursor: pointer;
			transition: all 0.3s;
		}

		.btn-notify:hover {
			background: #45a049;
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
		}

		.urgent-badge {
			position: absolute;
			top: 15px;
			right: 15px;
			background: #ff4444;
			color: #fff;
			padding: 6px 12px;
			border-radius: 20px;
			font-size: 11px;
			font-weight: 700;
			animation: shake 0.5s infinite;
		}

		@keyframes shake {
			0%, 100% { transform: translateX(0); }
			25% { transform: translateX(-5px); }
			75% { transform: translateX(5px); }
		}

		.notification-indicator {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
			color: #fff;
			padding: 15px 25px;
			border-radius: 50px;
			font-size: 14px;
			font-weight: 600;
			box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
			display: none;
			align-items: center;
			gap: 10px;
			z-index: 10000;
			animation: pulse 2s infinite;
		}

		.notification-indicator.active {
			display: flex;
		}

		@keyframes pulse {
			0%, 100% { transform: scale(1); }
			50% { transform: scale(1.05); }
		}

		.empty-state {
			text-align: center;
			padding: 80px 20px;
			color: var(--muted);
		}

		.empty-state-icon {
			font-size: 80px;
			margin-bottom: 20px;
		}

		.empty-state h3 {
			color: var(--accent);
			margin-bottom: 10px;
		}

		@media (max-width: 768px) {
			.orders-grid {
				grid-template-columns: 1fr;
			}

			.kitchen-header h1 {
				font-size: 20px;
			}

			.stat-box .value {
				font-size: 36px;
			}
		}
	</style>
</head>
<body>
	<div class="kitchen-header">
		<h1>
			<span>üë®‚Äçüç≥</span>
			<span>COCINA</span>
		</h1>
		<div class="kitchen-controls">
			<button class="btn btn-success" onclick="loadOrders()">üîÑ Actualizar</button>
			<button class="btn btn-secondary" onclick="toggleSound()">
				<span id="sound-icon">üîî</span> Sonido
			</button>
			<button class="btn btn-secondary" onclick="window.location.href='index.html'">üè† Volver</button>
		</div>
	</div>

	<div class="kitchen-main">
		<div class="stats-grid">
			<div class="stat-box">
				<h3>‚è≥ Pedidos Pendientes</h3>
				<div class="value" id="stat-pending">0</div>
			</div>
			<div class="stat-box">
				<h3>üë®‚Äçüç≥ En Preparaci√≥n</h3>
				<div class="value" id="stat-preparing">0</div>
			</div>
			<div class="stat-box">
				<h3>‚úÖ Completados Hoy</h3>
				<div class="value" id="stat-completed">0</div>
			</div>
			<div class="stat-box">
				<h3>‚è±Ô∏è Tiempo Promedio</h3>
				<div class="value" id="stat-time" style="font-size: 32px;">-</div>
			</div>
		</div>

		<div id="orders-container" class="orders-grid"></div>
	</div>

	<!-- Indicador de notificaciones enviadas -->
	<div id="notification-indicator" class="notification-indicator">
		<span>‚úÖ</span>
		<span>Notificaciones activas</span>
	</div>

	<script src="app.js"></script>
	<script>
		let soundEnabled = localStorage.getItem('kitchenSound') !== 'false';
		let autoRefreshInterval;

		async function init() {
			await loadInitialData();
			await initializeDefaultData();
			renderKitchen();
			startAutoRefresh();
			updateSoundIcon();
			updateNotificationIndicator();
		}

		function startAutoRefresh() {
			stopAutoRefresh();
			autoRefreshInterval = setInterval(async () => {
				await loadInitialData();
				renderKitchen();
				updateNotificationIndicator();
			}, 5000); // Actualizar cada 5 segundos
		}

		function stopAutoRefresh() {
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
			}
		}

		async function loadOrders() {
			const btn = event.target;
			btn.disabled = true;
			btn.textContent = '‚è≥ Actualizando...';
			
			await loadInitialData();
			renderKitchen();
			
			btn.disabled = false;
			btn.textContent = 'üîÑ Actualizar';
		}

		function renderKitchen() {
			const pendingOrders = AppState.orders.filter(o => o.status === 'pending');
			
			// Calcular estad√≠sticas
			const today = new Date().toISOString().split('T')[0];
			const completedToday = AppState.orders.filter(o => 
				o.status === 'completed' && 
				o.completedAt && 
				o.completedAt.startsWith(today)
			);

			let totalItemsCompleted = 0;
			let totalPreparationTime = 0;
			let ordersWithTime = 0;

			completedToday.forEach(order => {
				totalItemsCompleted += order.items.length;
				if (order.createdAt && order.completedAt) {
					const prepTime = (new Date(order.completedAt) - new Date(order.createdAt)) / 1000 / 60;
					totalPreparationTime += prepTime;
					ordersWithTime++;
				}
			});

			const avgTime = ordersWithTime > 0 ? (totalPreparationTime / ordersWithTime).toFixed(0) : 0;

			// Contar items en preparaci√≥n
			let itemsPreparing = 0;
			pendingOrders.forEach(order => {
				order.items.forEach(item => {
					if (item.kitchenStatus === 'preparing') itemsPreparing++;
				});
			});

			document.getElementById('stat-pending').textContent = pendingOrders.length;
			document.getElementById('stat-preparing').textContent = itemsPreparing;
			document.getElementById('stat-completed').textContent = totalItemsCompleted;
			document.getElementById('stat-time').textContent = avgTime > 0 ? `${avgTime} min` : '-';

			// Renderizar pedidos
			const container = document.getElementById('orders-container');
			
			if (pendingOrders.length === 0) {
				container.innerHTML = `
					<div class="empty-state" style="grid-column: 1/-1;">
						<div class="empty-state-icon">‚ú®</div>
						<h3>No hay pedidos pendientes</h3>
						<p>Todos los pedidos est√°n completados</p>
					</div>
				`;
				return;
			}

			container.innerHTML = pendingOrders
				.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
				.map(order => {
					const elapsedTime = Math.floor((Date.now() - new Date(order.createdAt)) / 1000 / 60);
					const isUrgent = elapsedTime > 15;
					const allItemsReady = order.items.every(item => item.kitchenStatus === 'ready');
					
					return `
						<div class="order-card ${isUrgent ? 'urgent' : ''} ${allItemsReady ? 'ready' : ''}" style="position: relative;">
							${isUrgent ? '<div class="urgent-badge">‚ö†Ô∏è URGENTE</div>' : ''}
							
							<div class="order-header">
								<div>
									<h2>Mesa ${order.tableNumber}</h2>
									<div class="order-time">
										‚è±Ô∏è ${elapsedTime} minutos ‚Ä¢ ${new Date(order.createdAt).toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'})}
									</div>
								</div>
								<span class="status-badge ${allItemsReady ? 'status-ready' : 'status-preparing'}">
									${allItemsReady ? '‚úÖ Todo Listo' : 'üë®‚Äçüç≥ Preparando'}
								</span>
							</div>

							<div class="items-list">
								${order.items.map(item => {
									const status = item.kitchenStatus || 'pending';
									
									return `
										<div class="item-row">
											<div class="item-info">
												<div class="item-name">${item.quantity}x ${item.name}</div>
												${item.notes ? `<div class="item-notes">üìù ${item.notes}</div>` : ''}
											</div>
											<div class="item-actions">
												<span class="status-badge status-${status}">
													${status === 'pending' ? '‚è≥ Pendiente' : status === 'preparing' ? 'üë®‚Äçüç≥ Preparando' : '‚úÖ Listo'}
												</span>
												${status !== 'ready' ? `
													<button 
														class="btn-action ${status === 'pending' ? 'btn-start' : 'btn-ready'}"
														onclick="updateItemStatus('${order.id}', '${item.menuItemId}', '${status === 'pending' ? 'preparing' : 'ready'}')">
														${status === 'pending' ? 'üî• Iniciar' : '‚úÖ Listo'}
													</button>
												` : '<span style="font-size: 32px;">‚úÖ</span>'}
											</div>
										</div>
									`;
								}).join('')}
							</div>

							${allItemsReady ? `
								<button class="btn-notify" onclick="notifyOrderReady('${order.id}')">
									üì¢ Notificar que el Pedido est√° Listo
								</button>
							` : ''}
						</div>
					`;
				}).join('');
		}

		async function updateItemStatus(orderId, menuItemId, newStatus) {
			const order = AppState.orders.find(o => o.id === orderId);
			if (!order) return;

			const item = order.items.find(i => i.menuItemId === menuItemId);
			if (!item) return;

			item.kitchenStatus = newStatus;

			// Verificar si todos los items est√°n listos
			const allItemsReady = order.items.every(item => item.kitchenStatus === 'ready');

			// Actualizar UI inmediatamente
			renderKitchen();

			// Guardar en servidor
			API.save('orders', AppState.orders).catch(error => {
				console.error('Error actualizando estado:', error);
			});

			// Si todos los items est√°n listos, notificar autom√°ticamente
			if (allItemsReady && !order.notified) {
				order.notified = true;
				notifyOrderReady(orderId);
			}
		}

		function notifyOrderReady(orderId) {
			const order = AppState.orders.find(o => o.id === orderId);
			if (!order) return;

			// Marcar timestamp de notificaci√≥n en el pedido
			order.kitchenNotifiedAt = new Date().toISOString();
			
			// Guardar en base de datos para sincronizaci√≥n cross-device
			API.save('orders', AppState.orders).catch(error => {
				console.error('Error guardando notificaci√≥n:', error);
			});

			// Enviar notificaci√≥n al panel principal (mismo dispositivo)
			const notification = {
				tableNumber: order.tableNumber,
				orderId: order.id,
				timestamp: order.kitchenNotifiedAt
			};
			
			localStorage.setItem('kitchenNotification', JSON.stringify(notification));

			// Reproducir sonido SOLO en cocina para confirmar
			if (soundEnabled) {
				playSound();
			}

			// Mostrar confirmaci√≥n en cocina
			const notifDiv = document.createElement('div');
			notifDiv.style.cssText = `
				position: fixed;
				top: 80px;
				right: 30px;
				background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
				color: #fff;
				padding: 20px 30px;
				border-radius: 12px;
				box-shadow: 0 8px 30px rgba(76, 175, 80, 0.5);
				z-index: 10000;
				font-size: 16px;
				font-weight: 600;
				animation: fadeIn 0.3s ease;
			`;
			
			notifDiv.innerHTML = `
				<div style="text-align: center;">
					<div style="font-size: 40px; margin-bottom: 10px;">‚úÖ</div>
					<div style="font-size: 18px; margin-bottom: 5px;">Notificaci√≥n Enviada</div>
					<div style="font-size: 14px; opacity: 0.9;">Mesa ${order.tableNumber} lista para servir</div>
				</div>
			`;

			document.body.appendChild(notifDiv);

			setTimeout(() => {
				notifDiv.style.animation = 'fadeOut 0.3s ease';
				setTimeout(() => notifDiv.remove(), 300);
			}, 3000);
		}

		function toggleSound() {
			soundEnabled = !soundEnabled;
			localStorage.setItem('kitchenSound', soundEnabled);
			updateSoundIcon();
		}

		function updateSoundIcon() {
			document.getElementById('sound-icon').textContent = soundEnabled ? 'üîî' : 'üîï';
		}

		function updateNotificationIndicator() {
			const indicator = document.getElementById('notification-indicator');
			const hasNotifiedOrders = AppState.orders.some(order => 
				order.kitchenNotifiedAt && 
				order.status === 'pending' &&
				order.items.every(item => item.kitchenStatus === 'ready')
			);
			
			if (hasNotifiedOrders) {
				indicator.classList.add('active');
			} else {
				indicator.classList.remove('active');
			}
		}

		function playSound() {
			try {
				const audioContext = new (window.AudioContext || window.webkitAudioContext)();
				const oscillator = audioContext.createOscillator();
				const gainNode = audioContext.createGain();
				
				oscillator.connect(gainNode);
				gainNode.connect(audioContext.destination);
				
				oscillator.frequency.value = 800;
				oscillator.type = 'sine';
				gainNode.gain.value = 0.3;
				
				oscillator.start(audioContext.currentTime);
				oscillator.stop(audioContext.currentTime + 0.2);
			} catch (error) {
				console.log('No se pudo reproducir sonido');
			}
		}

		// Detectar cuando la ventana pierde foco
		document.addEventListener('visibilitychange', () => {
			if (document.hidden) {
				stopAutoRefresh();
			} else {
				startAutoRefresh();
				loadInitialData().then(() => renderKitchen());
			}
		});

		init();
	</script>
</body>
</html>
